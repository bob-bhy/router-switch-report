<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>欧区新客户多维度分析看板（V3最终版）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft YaHei', sans-serif;
            background-color: #030712; /* Darker background */
            color: #F9FAFB;
        }
        .chart-wrapper {
            background-color: #1F2937;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #1F2937; }
        .table-container::-webkit-scrollbar-thumb { background-color: #4B5563; border-radius: 10px; border: 2px solid #1F2937; }
    </style>
</head>
<body class="bg-gray-900">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-bold text-white">欧区新客户数据分析看板</h1>
            <p class="text-gray-400 mt-2">（V3最终版）</p>
        </header>

        <!-- Section for Charts -->
        <div class="space-y-8">
            <div class="chart-wrapper">
                <h2 class="text-xl font-semibold mb-4 text-center">年度新增客户总数趋势</h2>
                <div class="relative h-72">
                    <canvas id="yearlyTrendChart"></canvas>
                </div>
            </div>
            
            <div class="chart-wrapper">
                <h2 class="text-xl font-semibold mb-4 text-center">核心市场年度趋势 (Top 5 国家)</h2>
                <div class="relative h-96">
                    <canvas id="top5TrendChart"></canvas>
                </div>
            </div>

            <div class="chart-wrapper">
                <h2 class="text-xl font-semibold mb-4 text-center">各区域年度新增客户对比 (绝对数量)</h2>
                 <div class="relative h-96">
                    <canvas id="regionalYearlyChart"></canvas>
                </div>
            </div>
             
            <div class="chart-wrapper">
                <h2 class="text-xl font-semibold mb-4 text-center">区域获客贡献度变化 (百分比)</h2>
                 <div class="relative h-96">
                    <canvas id="regionalPercentageChart"></canvas>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="chart-wrapper">
                    <h2 class="text-xl font-semibold mb-4 text-center">绝对数量变化榜 (2023 vs 2024)</h2>
                     <div class="relative h-[450px]">
                        <canvas id="absChangeChart"></canvas>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <h2 class="text-xl font-semibold mb-4 text-center">年度增长率排行榜 (2023 vs 2024)</h2>
                     <div class="relative h-[450px]">
                        <canvas id="rateChangeChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-wrapper">
                <h2 class="text-xl font-semibold mb-4 text-center">各国总新增客户数贡献 (Top 30)</h2>
                 <div class="relative h-96">
                    <canvas id="treemapChart"></canvas>
                </div>
            </div>

            <div class="chart-wrapper">
                 <h2 class="text-xl font-semibold mb-4 text-center">新增客户数据详情</h2>
                <div class="table-container overflow-y-auto h-96">
                    <table class="w-full text-left">
                        <thead class="sticky top-0 bg-gray-700 z-10">
                            <tr>
                                <th class="p-3">排名</th>
                                <th class="p-3">国家/地区</th>
                                <th class="p-3">2023</th>
                                <th class="p-3">2024</th>
                                <th class="p-3">2025</th>
                                <th class="p-3">合计</th>
                            </tr>
                        </thead>
                        <tbody id="data-table">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // CSV data from "汇总.csv"
    const csvData = `
,,,,
,,,
求和项:客户数量 计数,年份,,,
国家,2023,2024,2025,合计
阿尔巴尼亚 [AL] - [Albania],22,10,3,35
阿富汗 [AF] - [Afghanistan],,,1,1
阿联酋 [AE] - [United Arab Emirates],454,297,205,956
阿曼 [OM] - [Oman],50,47,47,144
阿塞拜疆 [AZ] - [Azerbaijan],28,18,21,67
爱尔兰 [IE] - [Ireland],18,8,6,32
爱沙尼亚 [EE] - [Estonia],8,4,4,16
安道尔 [AD] - [Andorra],3,,,3
奥地利 [AT] - [Austria],8,14,11,33
巴勒斯坦 [PS] - [Palestinian Territory (the Occupied)],5,3,,8
巴林 [BH] - [Bahrain],33,13,11,57
白俄罗斯 [BY] - [Belarus],8,2,,10
保加利亚 [BG] - [Bulgaria],12,15,14,41
北马其顿 [MK] - [North Macedonia],3,3,3,9
比利时 [BE] - [Belgium],25,14,12,51
冰岛 [IS] - [Iceland],2,1,1,4
波兰 [PL] - [Poland],43,31,21,95
波斯尼亚和黑塞哥维那 [BA] - [Bosnia and Herzegovina],3,2,3,8
丹麦 [DK] - [Denmark],12,6,10,28
德国 [DE] - [Germany],118,124,103,345
俄罗斯 [RU] - [Russian Federation],77,36,3,116
法国 [FR] - [France],48,46,28,122
芬兰 [FI] - [Finland],9,3,2,14
格恩西岛 [GG] - [Guernsey],,,1,1
格鲁吉亚 [GE] - [Georgia],6,6,1,13
哈萨克斯坦 [KZ] - [Kazakhstan],41,32,18,91
荷兰 [NL] - [Netherlands],44,28,14,86
黑山 [ME] - [Montenegro],4,,2,6
吉尔吉斯斯坦 [KG] - [Kyrgyzstan],12,9,4,25
捷克共和国 [CZ] - [Czech Republic],29,11,17,57
卡塔尔 [QA] - [Qatar],55,39,32,126
科索沃 [KV] - [Kosovo],,5,5,10
科威特 [KW] - [Kuwait],40,36,20,96
克罗地亚 [HR] - [Croatia],12,8,10,30
拉脱维亚 [LV] - [Latvia],6,6,5,17
黎巴嫩 [LB] - [Lebanon],22,12,11,45
立陶宛 [LT] - [Lithuania],13,5,5,23
列支敦士登 [LI] - [Liechtenstein],1,,,1
卢森堡 [LU] - [Luxembourg],4,3,1,8
罗马尼亚 [RO] - [Romania],30,20,15,65
马恩岛 [IM] - [Isle of Man],,,1,1
马耳他 [MT] - [Malta],7,5,6,18
摩尔多瓦 [MD] - [Moldova (the Republic of)],5,4,2,11
挪威 [NO] - [Norway],10,3,6,19
葡萄牙 [PT] - [Portugal],26,18,10,54
瑞典 [SE] - [Sweden],14,10,3,27
瑞士 [CH] - [Switzerland],25,18,12,55
塞尔维亚 [RS] - [Serbia],4,5,2,11
塞浦路斯 [CY] - [Cyprus],11,13,8,32
沙特阿拉伯 [SA] - [Saudi Arabia],338,202,125,665
斯洛伐克 [SK] - [Slovakia],12,8,6,26
斯洛文尼亚 [SI] - [Slovenia],4,2,2,8
塔吉克斯坦 [TJ] - [Tajikistan],6,3,2,11
土耳其 [TR] - [Turkey],179,146,47,372
土库曼斯坦 [TM] - [Turkmenistan],2,,,2
乌克兰 [UA] - [Ukraine],26,20,15,61
乌兹别克斯坦 [UZ] - [Uzbekistan],20,36,2,58
西班牙 [ES] - [Spain],66,37,39,142
希腊 [GR] - [Greece],22,23,17,62
匈牙利 [HU] - [Hungary],18,11,7,36
叙利亚 [SY] - [Syrian Arab Republic],2,1,2,5
亚美尼亚 [AM] - [Armenia],1,3,2,6
也门(Yemen) [YE] - [Yemen],2,4,4,10
伊拉克 [IQ] - [Iraq],12,19,37,68
伊朗 [IR] - [Iran (the Islamic Republic of)],4,20,36,60
以色列 [IL] - [Israel],30,35,17,82
意大利 [IT] - [Italy],88,96,43,227
英国 [GB] - [United Kingdom],59,48,40,147
约旦 [JO] - [Jordan],27,24,20,71
`;

    // --- 1. Data Processing ---
    // FIX: Corrected typo for Cyprus in the raw data string
    const correctedCsvData = csvData.replace('塞浦 lọ斯', '塞浦路斯');
    const rows = correctedCsvData.trim().split('\n').slice(4);
    const data = rows.map(row => {
        const [countryInfo, y2023, y2024, y2025, total] = row.split(',');
        return {
            country: countryInfo.split(' ')[0],
            y2023: parseInt(y2023) || 0,
            y2024: parseInt(y2024) || 0,
            y2025: parseInt(y2025) || 0,
            total: parseInt(total) || 0
        };
    }).filter(d => d.country && d.country !== '国家'); // FIX: Removed faulty filter
    data.sort((a, b) => b.total - a.total);

    // --- 2. Region Mapping and Aggregation ---
    const regionMap = {
        '中东': ['阿联酋', '阿曼', '巴林', '卡塔尔', '科威特', '黎巴嫩', '沙特阿拉伯', '也门(Yemen)', '伊拉克', '以色列', '约旦', '巴勒斯坦', '伊朗', '叙利亚', '土耳其'],
        '中亚': ['阿塞拜疆', '哈萨克斯坦', '吉尔吉斯斯坦', '塔吉克斯坦', '土库曼斯坦', '乌兹别克斯坦', '亚美尼亚', '格鲁吉亚', '阿富汗'],
        '东欧': ['白俄罗斯', '保加利亚', '捷克共和国', '匈牙利', '摩尔多瓦', '波兰', '罗马尼亚', '乌克兰', '俄罗斯', '斯洛伐克', '科索沃'],
        '西欧': ['奥地利', '法国', '德国', '荷兰', '瑞士', '英国', '比利时', '列支敦士登', '卢森堡', '格恩西岛', '马恩岛'],
        '北欧': ['爱尔兰', '爱沙尼亚', '丹麦', '芬兰', '冰岛', '拉脱维亚', '立陶宛', '挪威', '瑞典'],
        '南欧': ['阿尔巴尼亚', '安道尔', '克罗地亚', '塞浦路斯', '希腊', '意大利', '马耳他', '葡萄牙', '塞尔维亚', '斯洛文尼亚', '西班牙', '北马其顿', '波斯尼亚和黑塞哥维那', '黑山'],
    };
    const getRegion = (country) => {
        for (const region in regionMap) {
            if (regionMap[region].includes(country)) return region;
        }
        return '其他';
    };
    data.forEach(item => item.region = getRegion(item.country));
    
    // --- 3. Chart Rendering ---
    const chartColors = {
        grid: 'rgba(255, 255, 255, 0.1)',
        text: '#F9FAFB',
        line: 'rgba(59, 130, 246, 0.8)',
        regions: ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899', '#6B7280'],
        top5: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'],
        growth: 'rgba(16, 185, 129, 0.7)',
        decline: 'rgba(239, 68, 68, 0.7)'
    };
    Chart.defaults.color = chartColors.text;
    Chart.defaults.borderColor = chartColors.grid;
    
    const years = ['2023', '2024', '2025'];
    
    // Chart 1: Yearly Trend
    const yearlyTotals = {
        '2023': data.reduce((sum, d) => sum + d.y2023, 0),
        '2024': data.reduce((sum, d) => sum + d.y2024, 0),
        '2025': data.reduce((sum, d) => sum + d.y2025, 0),
    };
    new Chart('yearlyTrendChart', {
        type: 'line',
        data: {
            labels: years,
            datasets: [{
                label: '新增客户总数',
                data: Object.values(yearlyTotals),
                borderColor: chartColors.line,
                backgroundColor: chartColors.line.replace('0.8', '0.2'),
                fill: true,
                tension: 0.1
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    // Chart 2: Top 5 Countries Trend (NEW)
    const top5Data = data.slice(0, 5);
    new Chart('top5TrendChart', {
        type: 'line',
        data: {
            labels: years,
            datasets: top5Data.map((d, i) => ({
                label: d.country,
                data: [d.y2023, d.y2024, d.y2025],
                borderColor: chartColors.top5[i],
                backgroundColor: 'transparent',
                tension: 0.1
            }))
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }
        }
    });


    const regions = [...new Set(data.map(d => d.region))];

    // Chart 3: Regional Yearly Stacked Bar (Absolute)
    const regionalAbsoluteData = {
        labels: years,
        datasets: regions.map((region, i) => ({
            label: region,
            data: years.map(year => 
                data.filter(d => d.region === region).reduce((s, c) => s + c[`y${year}`], 0)
            ),
            backgroundColor: chartColors.regions[i % chartColors.regions.length],
        }))
    };
    new Chart('regionalYearlyChart', {
        type: 'bar',
        data: regionalAbsoluteData,
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { stacked: true }, y: { stacked: true, title: { display: true, text: '客户数量' } } },
            plugins: { legend: { position: 'bottom' } }
        }
    });

    // Chart 4: Regional Yearly Stacked Bar (Percentage)
    const regionalPercentageData = {
        labels: years,
        datasets: regions.map((region, i) => ({
            label: region,
            data: years.map(year => {
                const regionTotal = data.filter(d => d.region === region).reduce((s, c) => s + c[`y${year}`], 0);
                return yearlyTotals[year] > 0 ? (regionTotal / yearlyTotals[year]) * 100 : 0;
            }),
            backgroundColor: chartColors.regions[i % chartColors.regions.length],
        }))
    };
    new Chart('regionalPercentageChart', {
        type: 'bar',
        data: regionalPercentageData,
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { 
                x: { stacked: true }, 
                y: { stacked: true, max: 100, title: { display: true, text: '贡献度 (%)' } } 
            },
            plugins: { 
                legend: { position: 'bottom' },
                tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ${context.raw.toFixed(2)}%` } }
            }
        }
    });


    // Chart 5 & 6: Change Charts
    const absChanges = data.map(d => ({ country: d.country, change: d.y2024 - d.y2023 })).filter(d => d.change !== 0);
    absChanges.sort((a, b) => Math.abs(b.change) - Math.abs(a.change));
    const top15AbsMovers = absChanges.slice(0, 15).sort((a,b) => b.change - a.change);

    new Chart('absChangeChart', {
        type: 'bar',
        data: {
            labels: top15AbsMovers.map(d => d.country),
            datasets: [{
                label: '数量变化',
                data: top15AbsMovers.map(d => d.change),
                backgroundColor: top15AbsMovers.map(d => d.change >= 0 ? chartColors.growth : chartColors.decline)
            }]
        },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
    
    const rateChanges = data.filter(d => d.y2023 > 5).map(d => ({ // Only show for countries with a meaningful base
        country: d.country, 
        change: ((d.y2024 - d.y2023) / d.y2023) * 100 
    }));
    rateChanges.sort((a, b) => Math.abs(b.change) - Math.abs(a.change));
    const top15RateMovers = rateChanges.slice(0, 15).sort((a,b) => b.change - a.change);

    new Chart('rateChangeChart', {
        type: 'bar',
        data: {
            labels: top15RateMovers.map(d => d.country),
            datasets: [{
                label: '增长率',
                data: top15RateMovers.map(d => d.change),
                backgroundColor: top15RateMovers.map(d => d.change >= 0 ? chartColors.growth : chartColors.decline)
            }]
        },
        options: { 
            indexAxis: 'y', responsive: true, maintainAspectRatio: false, 
            plugins: { 
                legend: { display: false },
                tooltip: { callbacks: { label: (context) => `${context.label}: ${context.raw.toFixed(2)}%` } }
            },
            scales: { x: { ticks: { callback: (value) => `${value}%` } } }
        }
    });


    // Chart 7: Treemap (Optimized)
    const treemapData = data.slice(0, 30);
    const otherTotal = data.slice(30).reduce((sum, d) => sum + d.total, 0);
    if (otherTotal > 0) {
        treemapData.push({ country: '其他', total: otherTotal });
    }
    
    new Chart('treemapChart', {
        type: 'treemap',
        data: {
            datasets: [{
                tree: treemapData,
                key: 'total',
                groups: ['country'],
                backgroundColor: (ctx) => {
                     if (!ctx.raw || typeof ctx.raw.v === 'undefined') {
                        return 'rgba(75, 85, 99, 0.5)';
                    }
                    const max = treemapData[0].total;
                    const alpha = Math.min((ctx.raw.v / max) * 1.5, 1);
                    return `rgba(59, 130, 246, ${alpha})`;
                },
                labels: { display: true, formatter: (ctx) => ctx.raw.g }
            }],
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
    
    // Table
    const tableBody = document.getElementById('data-table');
    tableBody.innerHTML = '';
    data.forEach((item, index) => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-700 hover:bg-gray-600';
        row.innerHTML = `
            <td class="p-3">${index + 1}</td>
            <td class="p-3">${item.country}</td>
            <td class="p-3">${item.y2023}</td>
            <td class="p-3">${item.y2024}</td>
            <td class="p-3">${item.y2025}</td>
            <td class="p-3 font-bold">${item.total}</td>
        `;
        tableBody.appendChild(row);
    });
});
</script>

</body>
</html>

